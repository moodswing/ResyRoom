@using System.Globalization
@using System.Web.Script.Serialization
@using ResyRoom.Infraestructura.Extensiones
@using ResyRoom.ViewModels
@model ResyRoom.ViewModels.IViewStudioViewModel
<script src="@Url.Content("~/Scripts/knockout-3.1.0.js")" type="text/javascript"></script>
<link href="@Url.Content("~/Content/fullcalendar.css")" rel="stylesheet" type="text/css" />
<script src="@Url.Content("~/Scripts/moment.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/fullcalendar.js")" type="text/javascript"></script>

@{
    ViewBag.Title = @Model.Estudio.Nombre + " - ResyRoom";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script>
    var viewKoViewModel;
    var fecha;
    
    function ViewKoViewModel() {
        var self = this;
        self.TabSeleccionado = ko.observable("Reservas");
        self.SalaSeleccionada = ko.observable(@(Model.Estudio.Salas.First().IdSala));
        self.Salas = ko.observable([]);
        self.FromCalendar = ko.observable();
        self.HoraReservaDesde = ko.observable();
        self.HoraReservaHasta = ko.observable();
        self.IdSalaReserva = ko.observable();
        self.ReservaRealizadaConExito = ko.observable('@(Model.ReservaRealizadaConExito)');
        
        self.FechaReserva = ko.computed(function() {
            return self.HoraReservaDesde() != null ? self.HoraReservaDesde().format('dddd, D [de] MMMM YYYY') : '--';
        });
        self.HoraDesdeHastaReserva = ko.computed(function() {
            return self.HoraReservaDesde() != null && self.HoraReservaHasta() != null ? "Desde las " + self.HoraReservaDesde().format('HH:mm') + " hasta las " + self.HoraReservaHasta().format('HH:mm') + " horas" : '--';
        });
        self.PrecioReserva = ko.computed(function() {
            if (self.IdSalaReserva() == null || self.HoraReservaHasta() == null || self.HoraReservaDesde() == null) return "";
            var sala = ko.utils.arrayFirst(viewKoViewModel.Salas(), function(item) { return item.IdSala == self.IdSalaReserva(); });
            return "$" + (self.HoraReservaHasta().diff(self.HoraReservaDesde()) / moment.duration(sala.DuracionBloque) * sala.PrecioBloque).toString().toMoney();
        });
        
        self.FechaReservaForm = ko.computed(function() { return self.HoraReservaDesde() != null ? self.HoraReservaDesde().format('YYYY-M-D 00:00:00 [PM]') : ''; });
        self.HoraDesdeForm = ko.computed(function() { return self.HoraReservaDesde() != null ? self.HoraReservaDesde().format('H:mm') : ''; });
        self.HoraHastaForm = ko.computed(function() { return self.HoraReservaHasta() != null ? self.HoraReservaHasta().format('H:mm') : ''; });
    }
    
    function GetDateTimeToJson(date) {
        return new Date(parseInt(date.replace("/Date(", "").replace(")/", ""), 10));
    }

    function ToHourMinuteFormat(duration) {
        return moment().subtract(moment.duration(moment().format("HH:mm"))).add(duration).format("HH:mm");
    }

    $(document).ready(function () {
        @if (Model.ReservaRealizadaConExito == true || Model.ReservaRealizadaConExito == false)
        {
            <text>
                $("#successfulBookingOverlay").show();
                $("#successfulBooking").toggle("clip");
            </text>
        }

        if ($(".general-profile-info ul li").length % 2 == 0) {
            $($(".general-profile-info ul li")[$(".general-profile-info ul li").length - 2]).css("border-bottom", "0");
        }

        viewKoViewModel = new ViewKoViewModel();
        ko.applyBindings(viewKoViewModel);

        $(".equipment-boxes").css("width", $(".studio-equipment").width() + "px");
        
        @foreach (var sala in @Model.Estudio.Salas)
        {
            <text>
            var day = 0;
            var openDays = "@(sala.HorarioActivo.DíasAbierto)";
            var diasCerrados = [];
            
            viewKoViewModel.Salas().push(
            { 
                IdSala: @(sala.IdSala), 
                ReservasPorDia: @Html.Raw(new JavaScriptSerializer().Serialize(sala.ListadoReservasPorDía)),
                Reservas: ko.observable(@Html.Raw(new JavaScriptSerializer().Serialize(sala.ListadoReservas))),
                HoraApertura: "@(sala.HorarioActivo.HoraApertura)",
                HoraCierre: "@(sala.HorarioActivo.HoraCierre)",
                DuracionBloque: "@(sala.HorarioActivo.DuracionBloque)",
                PrecioBloque: "@(sala.Precio)"
            });

            for (day = 0; day < 7; day++)
            {
                if (openDays.indexOf(day) == -1)
                    diasCerrados.push(day);
            }
            
            $('#calendar@(sala.IdSala)').fullCalendar({
                header: {
                    left:   'title',
                    center: 'month,agendaWeek,agendaDay',
                    right:  'today prev,next'
                },
                monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                dayNames: ['Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sábado'],
                dayNamesShort: ['Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sábado'],
                buttonText: {
                    today: "Hoy",
                    month: "Mes",
                    week: "Semana",
                    day: "Día"
                },
                closedDays: diasCerrados,
                columnFormat: {
                    month: 'ddd',
                    week: 'ddd D/M',
                    day: 'dddd D/M'
                },
                firstDay: 1,
                selectable: {
                    agendaDay: true,
                    agendaWeek: true,
                    'default': false,
                },
                defaultView: 'month',
                firstHour: 10,
                allDayDefault: false,
                lazyFetching: true,
                slotDuration: "@(sala.HorarioActivo.DuracionBloque)",
                minTime: "@(sala.HorarioActivo.HoraApertura)",
                maxTime: "@(sala.HorarioActivo.HoraCierre)",
                dayRender: function(date, cell) {
                    var sala = ko.utils.arrayFirst(viewKoViewModel.Salas(), function(item) { return item.IdSala == @(sala.IdSala); });
                    if (diasCerrados.indexOf(date.day()) != -1) {
                        cell.addClass("fc-inactive");
                        cell.find(".fc-day-content > div").text("No disponible");
                    }
                    else {
                        var tieneReservas = false;
                        for(var i = 0; i < sala.ReservasPorDia.length; i ++) {
                            var dailySlots = (moment.duration(sala.HoraCierre)._milliseconds - moment.duration(sala.HoraApertura)._milliseconds) / moment.duration(sala.DuracionBloque)._milliseconds;

                            var fecha = GetDateTimeToJson(sala.ReservasPorDia[i].Dia);
                            var fechaFormatted = moment(fecha).format("YYYY-MM-DD");

                            if (date.format("YYYY-MM-DD") == fechaFormatted) {
                                var slotsDisponibles = dailySlots - sala.ReservasPorDia[i].NroReservas;
                                cell.find(".fc-day-content > div").text(slotsDisponibles + " espacios disponibles");
                                var tieneReservas = true;

                                if (slotsDisponibles == 0) {
                                    cell.find(".fc-day-content > div").text("Sin espacios disponibles");
                                    cell.addClass("fc-inactive");
                                }
                            }
                        }

                        if (!tieneReservas) {
                            cell.find(".fc-day-content > div").text("Todo el día disponible");
                        }
                    }
                },
                events: function(start, end, timezone, callback) {
                    var sala = ko.utils.arrayFirst(viewKoViewModel.Salas(), function(item) { return item.IdSala == @(sala.IdSala); });
                    
                    var events = [];
                    for(var i = 0; i < sala.Reservas().length; i ++) {
                        console.log(GetDateTimeToJson(sala.Reservas()[i].Dia));
                        var desde = ToHourMinuteFormat(moment.duration(sala.Reservas()[i].Desde));
                        var hasta = ToHourMinuteFormat(moment.duration(sala.Reservas()[i].Hasta));
                        
                        if ((moment.duration(hasta) - moment.duration(desde)) > moment.duration(sala.DuracionBloque)) {
                            var a = moment.duration(desde), b = moment.duration(hasta), bloque = moment.duration(sala.DuracionBloque);
                            
                            while (a < b) {
                                events.push({
                                    title: "Reservado",
                                    start: moment(GetDateTimeToJson(sala.Reservas()[i].Dia)).format("YYYY-MM-DD") + " " + ToHourMinuteFormat(a),
                                    end: moment(GetDateTimeToJson(sala.Reservas()[i].Dia)).format("YYYY-MM-DD") + " " + ToHourMinuteFormat(moment.duration(a + bloque)),
                                });
                            
                                a = moment.duration(a + bloque);
                            }
                        }
                        else {
                            events.push({
                                title: "Reservado",
                                start: moment(GetDateTimeToJson(sala.Reservas()[i].Dia)).format("YYYY-MM-DD") + " " + desde,
                                end: moment(GetDateTimeToJson(sala.Reservas()[i].Dia)).format("YYYY-MM-DD") + " " + hasta,
                            });
                        }
                    }
                    
                    callback(events);
                },
                eventRender: function(event, element, view) {
                    if (view.name == "month")
                        return false;
                    
                    element.find(".fc-event-time").remove();
                    element.find(".fc-event-inner").addClass("div-table");
                    element.find(".fc-event-title").addClass("div-cell");
                    element.find(".fc-event-title").css("vertical-align", "middle");
                },
                handleWindowResize: false,
                eventColor: '#EFEFEF',
                eventTextColor: '#5D5D5D',
                select: function(start, end, jsEvent, view) {
                    viewKoViewModel.HoraReservaDesde(start);
                    viewKoViewModel.HoraReservaHasta(end);
                    viewKoViewModel.IdSalaReserva(@(sala.IdSala));

                    if (diasCerrados.indexOf(start.day()) != -1) {
                        viewKoViewModel.HoraReservaDesde(null);
                        viewKoViewModel.HoraReservaHasta(null);
                        viewKoViewModel.IdSalaReserva(null);
                    }
                },
                unselectAuto: false,
                viewRender: function(view, element) {
                    var sala;
                    var fecha;
                    var reservas;
                    var dailySlots;
                    var slotsDisponibles;

                    viewKoViewModel.HoraReservaDesde(null);
                    viewKoViewModel.HoraReservaHasta(null);
                    viewKoViewModel.IdSalaReserva(null);
                        
                    if ((view.name == "agendaDay" && viewKoViewModel.FromCalendar()) || view.name == "agendaWeek") {
                        sala = ko.utils.arrayFirst(viewKoViewModel.Salas(), function(item) { return item.IdSala == @(sala.IdSala); });
                        fecha = $("#calendar@(sala.IdSala)").fullCalendar("getDate").format("YYYY-MM-DD");
                        reservas = ko.utils.arrayFilter(sala.Reservas(), function(item) { return moment(GetDateTimeToJson(item.Dia)).format("YYYY-MM-DD") == fecha; });
                        dailySlots = (moment.duration(sala.HoraCierre)._milliseconds - moment.duration(sala.HoraApertura)._milliseconds) / moment.duration(sala.DuracionBloque)._milliseconds;
                        slotsDisponibles = dailySlots - reservas.length;
                    }

                    if (view.name == "agendaDay" && viewKoViewModel.FromCalendar()) {
                        view.allDayRow().find(".fc-day-content > div").text("")

                        if (slotsDisponibles == 0) {
                            view.allDayRow().find(".fc-day-content > div").text("Sin espacios disponibles. Favor buscar durante otra fecha.")
                        }
                        else if (slotsDisponibles < dailySlots) {
                            view.allDayRow().find(".fc-day-content > div").text("Quedan " + slotsDisponibles + " espacios disponibles")
                        }

                        var cell = element.find("[class^='fc-slot'] .fc-widget-content");
                        $(cell).css("vertical-align", "baseline");
                        $(cell).removeClass("fc-inactive");
                        $(cell).find("> div").text("");

                        if (diasCerrados.indexOf($("#calendar@(sala.IdSala)").fullCalendar("getDate").day()) != -1) {
                            if (cell.length > 0) {
                                $(cell).css("vertical-align", "middle");
                                $(cell).addClass("fc-inactive");
                                $(cell).find("> div").text("No Disponible");
                            }
                        }
                    }
                },
                dayClick: function(date, allDay, jsEvent, view) {
                    //if (allDay && $(this).is('td.fc-day') && !$(this).is('td.fc-inactive')) {
                    if (allDay && $(this).is('td.fc-day')) {
                        $('#calendar@(sala.IdSala)').fullCalendar('changeView', 'agendaDay');
                        viewKoViewModel.FromCalendar(true);
                        $('#calendar@(sala.IdSala)').fullCalendar('gotoDate', date);   
                    }
                }
            });
            </text>
        }
    });
</script>
<div id="successfulBookingOverlay" class="successful-booking-overlay"></div>
<div id="successfulBooking" class="successful-booking">
    <div class="successful-booking-container" data-bind="visible: ReservaRealizadaConExito() == 'True'">
        <h3>Tu reserva se ha realizado con éxito!</h3>
        <span>Te envíaremos un correo de confirmación con los datos de tu reserva.</span>
    </div>
    <div class="successful-booking-container" data-bind="visible: ReservaRealizadaConExito() == 'False'">
        <h3>Lo sentimos, no se ha podido realizar tu reserva</h3>
        <span>Por favor vuelve a verificar que la hora que has intentado reservar esté disponible.</span>
    </div>
    <a id="closeSuccessfulBooking" href="#" class="close-message" data-bind="click: function() { $('#successfulBookingOverlay').hide(); $('#successfulBooking').toggle('clip'); }">Cerrar</a>
</div>
<div class="div-table studio-search-page">
    @Html.Partial("_RankingSidebar", (BaseViewModel)Model)
    <div class="div-cell search-form">
        <div class="studio-profile-title">
            <h3>@Model.Estudio.Nombre</h3>
            <span>@Model.Estudio.Direccion, @Model.Estudio.Comuna.Descripcion, @Model.Estudio.Comuna.Region.Descripcion</span>
            <div class="studio-profile-tabs">
                <ul>
                    <li data-bind="css: { 'tab-selected': (TabSeleccionado() == 'Info') }, click: function () { viewKoViewModel.TabSeleccionado('Info'); }">Información General</li>
                    <li data-bind="css: { 'tab-selected': (TabSeleccionado() == 'Salas') }, click: function () { viewKoViewModel.TabSeleccionado('Salas'); }">Salas</li>
                    <li data-bind="css: { 'tab-selected': (TabSeleccionado() == 'Equipos') }, click: function () { viewKoViewModel.TabSeleccionado('Equipos'); }">Equipos</li>
                    <li data-bind="css: { 'tab-selected': (TabSeleccionado() == 'Reservas') }, click: function () { viewKoViewModel.TabSeleccionado('Reservas'); }">Reservas</li>
                </ul>
            </div>
        </div>
        <div class="studio-general-info" data-bind="visible: (TabSeleccionado() == 'Info')">
            <div class="cover-studio-picture"></div>
            <div class="general-profile-info">
                <h4>Información general</h4>
                <ul>
                    <li>@Html.LabelFor(m => m.Estudio.PrecioPorHoraDesde): @Model.Estudio.PrecioPorHoraDesde</li>
                    <li>@Html.LabelFor(m => m.Estudio.Email): @Model.Estudio.Email</li>
                    @if (!string.IsNullOrEmpty(Model.Estudio.Telefono))
                    {
                        <li>@Html.LabelFor(m => m.Estudio.Telefono): @Model.Estudio.Telefono</li>
                    }
                    @if (!string.IsNullOrEmpty(Model.Estudio.Celular))
                    {
                        <li>@Html.LabelFor(m => m.Estudio.Celular): @Model.Estudio.Celular</li>
                    }
                    <li>Número de salas: @Model.Estudio.Salas.Count()</li>
                    <li>@Html.LabelFor(m => m.Estudio.NroDeReservasTotales): @Model.Estudio.NroDeReservasTotales</li>
                    <li>@Html.LabelFor(m => m.Estudio.PoseeSalaConDoblePedal): @(Model.Estudio.PoseeSalaConDoblePedal ? "Sí" : "No")</li>
                    <li>@Html.LabelFor(m => m.Estudio.PoseeSalaConSetDePlatos): @(Model.Estudio.PoseeSalaConSetDePlatos ? "Sí" : "No")</li>
                    <li>@Html.LabelFor(m => m.Estudio.PoseeComentarios): @(Model.Estudio.PoseeComentarios ? "Sí" : "No")</li>
                    <li>@Html.LabelFor(m => m.Estudio.PoseeInfoDeEquipos): @(Model.Estudio.PoseeInfoDeEquipos ? "Sí" : "No")</li>
                    <li>@Html.LabelFor(m => m.Estudio.PoseeGrabacion): @(Model.Estudio.PoseeGrabacion ? "Sí" : "No")</li>
                </ul>
            </div>
        </div>
        <div class="studio-rooms" data-bind="visible: (TabSeleccionado() == 'Salas')">
            <h4>Listado de Salas</h4>
            @foreach (var sala in @Model.Estudio.Salas)
            {
                <div class="div-table studio-room-container" style="@(sala.DatosGrabacion == null ? "width: 60%" : "")">
                    <div class="studio-info-room div-cell">
                        <div class="room-name">@sala.Nombre</div>
                        <ul>
                            <li><span class="span-label">Tamaño:</span> <span class="span-value">@sala.Tamaño</span></li>
                            <li><span class="span-label">Doble pedal:</span> <span class="span-value">@(sala.DoblePedal == true ? "Sí" : "No")</span></li>
                            <li><span class="span-label">Set de platos:</span> <span class="span-value">@(sala.SetDePlatos == true ? "Sí" : "No")</span></li>
                        </ul>
                        <div class="room-price">Precio x hr: <span>@sala.Precio.ToCurrency()</span></div>
                    </div>
                    @if (sala.DatosGrabacion != null)
                    {
                        <div class="studio-room-recording div-cell">
                            <div class="room-name">Grabación</div>
                            <ul>
                                <li><span class="span-label">Masterización:</span> <span class="span-value">@(sala.DatosGrabacion.Masterizacion == true ? "Sí" : "No")</span></li>
                            </ul>
                            <div class="recording-price">Precio x canción: <span>@sala.DatosGrabacion.PrecioPorCancion.ToCurrency()</span></div>
                        </div>    
                    }
                </div>
            }
        </div>
        <div class="studio-equipment" data-bind="visible: (TabSeleccionado() == 'Equipos')">
            <h4>Equipos</h4>
            <div class="equipment-menu">
                <ul class="list-menu">
                    @foreach (var sala in @Model.Estudio.Salas)
                    {
                        <li data-bind="css: { 'room-selected': (SalaSeleccionada() == @sala.IdSala) }, click: function () { viewKoViewModel.SalaSeleccionada(@(sala.IdSala)); }">@sala.Nombre</li>
                    }
                </ul>
            </div>
            @foreach (var sala in @Model.Estudio.Salas)
            {
                <div class="equipment-boxes" data-bind="visible: (SalaSeleccionada() == @sala.IdSala)">
                    @foreach (var equipo in sala.Equipos.OrderByDescending(e => e.PrecioAdicional))
                    {
                        <div class="equipment-box">
                            <div class="equipment-name">@equipo.Nombre</div>
                            <div>@equipo.Descripcion</div>
                            @if (equipo.PrecioAdicional > 0)
                            {
                                <div class="additional-price">Precio Adicional: <span>+ @equipo.PrecioAdicional.ToCurrency()</span></div>
                            }
                            <div class="equipment-picture" style="background: url(@(equipo.Fotografia)); background-size: 100%; background-position: center center; background-repeat: no-repeat;"></div>
                        </div>
                    }
                </div>
            }
        </div>
        <div class="studio-booking" data-bind="visible: (TabSeleccionado() == 'Reservas')">
            <h4>Horarios</h4>
            <div class="booking-menu">
                <ul class="list-menu">
                    @foreach (var sala in @Model.Estudio.Salas)
                    {
                        <li data-bind="css: { 'room-selected': (SalaSeleccionada() == @sala.IdSala) }, click: function () { viewKoViewModel.SalaSeleccionada(@(sala.IdSala)); }">@sala.Nombre</li>
                    }
                </ul>
            </div>
            @foreach (var sala in @Model.Estudio.Salas)
            {
                <div class="div-table" data-bind="visible: (SalaSeleccionada() == @sala.IdSala)" style="width: 100%">
                    <div id="calendar@(sala.IdSala)" class="calendar div-cell"></div>
                    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "BookingForm" + @sala.IdSala }))
                    {
                        <div class="booking div-cell">
                            <div class="inner-div">
                                <h4>Reserva de Hora</h4>
                                <div>
                                    <span class="booking-label">día</span>
                                    <span class="booking-value" data-bind="text: FechaReserva()"></span>
                                    @Html.HiddenFor(s => s.Reserva.Fecha, new { data_bind = "value: FechaReservaForm()" } )
                                </div>
                                <div>
                                    <span class="booking-label">hora</span>
                                    <span class="booking-value" data-bind="text: HoraDesdeHastaReserva()"></span>
                                    @Html.HiddenFor(s => s.Reserva.Desde, new { data_bind = "value: HoraDesdeForm()" } )
                                    @Html.HiddenFor(s => s.Reserva.Hasta, new { data_bind = "value: HoraHastaForm()" } )
                                </div>
                                <div>
                                    <span class="booking-label">estudio</span>
                                    <span class="booking-value">@sala.Estudio.Nombre</span>
                                </div>
                                <div>
                                    <span class="booking-label">sala</span>
                                    <span class="booking-value">@sala.Nombre</span>
                                </div>
                                <div>
                                    <span class="booking-label booking-price-label">precio total</span>
                                    <span class="booking-value booking-price" data-bind="text: PrecioReserva()"></span>
                                </div>
                                <div class="book-hour">
                                    @Html.HiddenFor(s => s.Reserva.IdSala, new { data_bind = "value: IdSalaReserva()" } )
                                    <input type="submit" class="botonGrande" value="reservar hora" />
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>